В настоящий момент основным методом авторизации REST запроса является механихм HMAC (hash based message authentication)

h3. Авторизация с помощью HMAC

Что такое HMAC Можно прочитать тут: http://restcookbook.com/Basics/loggingin/


**Важно! Информация размещенная по данной ссылке является лишь иллюстрацией различных техник авторизации HTTP запросов. Алгоритмы, форматы данных и пр. элементы API представленные в статье на restcookbook.com могут отличатся от требований предоставляемый API системы Hive.**

Основной алогритм, принятый для вычисления Message Digest'а - *SHA256*

Для авторизации на сервере нужно будет передать кучку данных в Header'е HTTP запроса:
* заголовок *Date* в формате *RFC-1123*
* заголовок *Authentication* Следующего содержания: @hmac {identity}:{nonce}:{digest}@, где:
** *identity* - Идентификатор пользователя, от имени которого делается запрос {login, номер телефона, что-то еще}. С помощью этого идентификатора система должна будет обнаружить ключь соответсвующий данному бользователю.
** *nonce* - некоторое целое число, уникально идентифицирующее запрос на некотором дискретном временном промежутке (например 10 мин). Каждый новый запрос должен сопровождаться новым значением *nonce*
** *digest* - Подпись сообщения вычисляемая как @base64encode(hmac("sha256", {secret}, {Request.method} + {Request.uri} + {Request.header.Date} + {nonce}))@. Тут *secret* - секретный ключ, расшаренный между клиентом и сервисом. Для *POST* запроса вида *"http://localhost:8080/api/client/mobile/1.0/orders"* вычислить digest можно следующим образом: @base64encode(hmac("sha256", {secret}, "POST" + "/api/client/mobile/1.0/orders" + "2015-10-09T12:15:07.498+07:00" + "114696735"))@.

----

Пример Header'ов необходим для подписи
<pre>Date:2015-10-09T12:15:07.498+07:00
Authentication:hmac system:114696735:7pi1GNhLzUSp5JVKFgkB0VZykud-fT3wJOVqiwDnKOE=</pre>

----

В данном API *identity* и *secret* получаются в ходе [[регистрации|Подтверждение-клиента#confirmed]].

----

Пример формирования заголовков *Date* и *Authentication* на Java

```java

import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import java.nio.charset.Charset;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.SecureRandom;
import java.time.OffsetDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;


/**
 * Naive implementation of HMAC Signer.
 * Beware!: It is not thread safe!!!
 */
public class NaiveHmacSigner {

    private final Mac mac;
    private final String identity;
    private final SecureRandom rnd = new SecureRandom();


    public NaiveHmacSigner(String identity, Mac mac) {
        this.mac = mac;
        this.identity = identity;
    }

    private static final Charset UTF8 = Charset.forName("UTF-8");
    private static final DateTimeFormatter DATEFORMAT =
            DateTimeFormatter.RFC_1123_DATE_TIME;
    

    public Map<String, String> newSignature(String method, String uri) {

        final String dateHeaderValue = OffsetDateTime.now().format(DATEFORMAT);
        final String nonce = "" + Math.abs(this.rnd.nextInt());
        final String signData = method + uri + dateHeaderValue + nonce;

        this.mac.reset();
        final byte[] signBytes = this.mac.doFinal(signData.getBytes(UTF8));
        final String signBase64 = Base64.getEncoder().encodeToString(signBytes);
        final String authHeaderValue =
                String.format("hmac %s:%s:%s", this.identity, nonce, signBase64);

        final Map<String, String> result = new HashMap<>();
        result.put("Date", dateHeaderValue);
        result.put("Authentication", authHeaderValue);
        return result;
    }


    private static final  String HMAC_SHA256_KEYSPEC = "HmacSHA256";


    public static NaiveHmacSigner newSigner(String identity, byte[] secret)
            throws NoSuchAlgorithmException, InvalidKeyException {

        final Mac mac = Mac.getInstance(HMAC_SHA256_KEYSPEC);
        final SecretKeySpec spec = new SecretKeySpec(secret, HMAC_SHA256_KEYSPEC);
        mac.init(spec);
        return new NaiveHmacSigner(identity, mac);
    }
}

```